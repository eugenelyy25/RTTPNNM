<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Prediction Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš¦</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    
    <style>
        /* Custom Colors & Shapes */
        :root {
            --cyan-pane: #00FFFF;
            --btn-yellow: #FFFF00;
            --btn-lime: #00FF00;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; overflow-y: scroll; }
        
        .cyan-pane {
            background-color: var(--cyan-pane);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 1rem;
        }

        .pill-btn {
            border-radius: 9999px;
            padding: 4px 12px; /* Micro padding */
            font-weight: bold;
            font-size: 0.75rem; /* Micro font */
            cursor: pointer;
            border: 1px solid #000;
            text-align: center;
            white-space: nowrap;
        }
        
        .pill-btn:hover { opacity: 0.8; }
        .pill-yellow { background-color: var(--btn-yellow); color: black; }
        .pill-lime { background-color: var(--btn-lime); color: black; }
        .pill-active { border: 2px solid #1d4ed8; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }

        /* ULTRA COMPACT GRID */
        .graph-container {
            display: grid;
            /* Small columns (min 240px) */
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.5rem; /* Tiny gap */
            padding: 0.5rem;
        }
        .graph-card {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 80px; /* Fixed total card height */
        }

        /* Weather Widget Compact */
        .weather-widget {
            border: 1px solid white;
            border-radius: 6px;
            overflow: hidden;
            width: 120px; 
            height: 60px;
            background: #000;
        }

        #map { height: 75vh; width: 100%; border-radius: 8px; z-index: 1; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: none; margin: 10px auto;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="cyan-pane flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-extrabold text-slate-800 tracking-tight">ðŸš¦ TrafficPred</h1>
            
            <div class="flex gap-1">
                <button onclick="switchTab('chart')" id="btn-chart" class="pill-btn pill-yellow pill-active">Charts</button>
                <button onclick="switchTab('cctv')" id="btn-cctv" class="pill-btn pill-lime">CCTV</button>
                <button onclick="switchTab('model')" id="btn-model" class="pill-btn pill-yellow">Model</button>
            </div>
            
            <div class="hidden md:flex gap-1 ml-4" id="date-buttons">
                <span class="text-xs text-gray-500 self-center">Loading...</span>
            </div>
        </div>

        <div class="flex items-center gap-3 hidden lg:flex">
            <div class="text-right text-[10px] font-mono leading-tight">
                <div class="text-gray-500">Last Update</div>
                <div id="refresh-time" class="font-bold">--:--</div>
            </div>
            <div class="weather-widget relative">
                <iframe width="120" height="60" src="https://embed.windy.com/embed2.html?lat=3.127&lon=101.650&zoom=10&level=surface&overlay=rain&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1" frameborder="0" style="pointer-events:none;"></iframe>
            </div>
        </div>
    </header>

    <div class="md:hidden p-2 bg-gray-100 flex overflow-x-auto gap-2" id="date-buttons-mobile"></div>

    <main class="flex-grow bg-gray-50 overflow-y-auto">
        
        <div id="tab-chart" class="block">
            <div id="graphs-wrapper" class="graph-container">
                <p class="text-center w-full mt-4 text-xs text-gray-400">Loading Data...</p>
            </div>
        </div>

        <div id="tab-cctv" class="hidden h-full p-2">
            <div id="map" class="h-full w-full"></div>
        </div>

        <div id="tab-model" class="hidden container mx-auto max-w-4xl p-4">
            <div class="bg-white p-4 rounded shadow border border-gray-200">
                <h2 class="text-lg font-bold mb-4">Model Metrics</h2>
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button onclick="runModelTest('LSTM', 'CV-10')" class="pill-btn pill-lime">LSTM (CV)</button>
                    <button onclick="runModelTest('RF', 'CV-10')" class="pill-btn pill-lime">RF (CV)</button>
                    <button onclick="runModelTest('LR', 'CV-10')" class="pill-btn pill-yellow">LR (CV)</button>
                    <button onclick="runModelTest('KNN', 'CV-10')" class="pill-btn pill-yellow">KNN (CV)</button>
                </div>
                <div class="loader" id="model-loader"></div>
                <div id="model-results" class="hidden">
                    <h3 class="text-sm font-bold text-blue-800" id="result-title">Results</h3>
                    <div id="result-body" class="text-xs mt-2 grid grid-cols-2 gap-2"></div>
                </div>
                <button onclick="downloadCSV()" class="pill-btn pill-lime mt-4 w-full">Download CSV</button>
            </div>
        </div>

    </main>

    <script>
        const REPO_CSV_URL = './traffic_data.csv';
        let rawData = [], organizedData = {}, uniqueDates = [], uniqueRoutes = [];
        let mapInitialized = false, mapObject = null, charts = {}; 

        window.onload = () => { updateTime(); fetchData(); };

        function updateTime() {
            document.getElementById('refresh-time').innerText = new Date().toLocaleTimeString('en-MY', {hour:'2-digit', minute:'2-digit'});
        }

        function switchTab(t) {
            ['chart', 'cctv', 'model'].forEach(x => {
                document.getElementById(`tab-${x}`).classList.add('hidden');
                document.getElementById(`btn-${x}`).classList.remove('pill-active');
            });
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.getElementById(`btn-${t}`).classList.add('pill-active');
            if(t === 'cctv' && !mapInitialized) setTimeout(initMap, 200);
        }

        function fetchData() {
            Papa.parse(REPO_CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => { rawData = res.data; if(rawData.length) processData(rawData); },
                error: () => document.getElementById('graphs-wrapper').innerHTML = "Failed to load CSV"
            });
        }

        function processData(data) {
            organizedData = {}; let rSet = new Set(), dSet = new Set();
            data.forEach(row => {
                const rKey = `${row.origin_location} -> ${row.destination_location}`;
                rSet.add(rKey); dSet.add(row.date);
                if (!organizedData[row.date]) organizedData[row.date] = {};
                if (!organizedData[row.date][rKey]) organizedData[row.date][rKey] = [];
                organizedData[row.date][rKey].push({ t: parseInt(row.timestamp), v: parseInt(row.calculated_journeytime_minute) });
            });
            uniqueRoutes = Array.from(rSet);
            uniqueDates = Array.from(dSet).sort((a,b) => {
                let [dA, mA, yA] = a.split('.'); let [dB, mB, yB] = b.split('.');
                return new Date(`20${yA}`, mA-1, dA) - new Date(`20${yB}`, mB-1, dB);
            });
            generateDateButtons();
            if(uniqueDates.length) updateCharts(uniqueDates[uniqueDates.length-1]);
        }

        function generateDateButtons() {
            const containers = [document.getElementById('date-buttons'), document.getElementById('date-buttons-mobile')];
            containers.forEach(c => {
                if(!c) return;
                c.innerHTML = '';
                uniqueDates.slice(-4).forEach(d => {
                    const b = document.createElement('button');
                    b.className = "pill-btn pill-lime text-xs mx-0.5";
                    b.innerText = d.split('.')[0] + '/' + d.split('.')[1]; // Short date DD/MM
                    b.onclick = () => updateCharts(d);
                    c.appendChild(b);
                });
                const p = document.createElement('button');
                p.className = "pill-btn pill-yellow text-xs mx-0.5";
                p.innerText = "PRED";
                p.onclick = () => updateCharts('PREDICTION');
                c.appendChild(p);
            });
        }

        function updateCharts(date) {
            const container = document.getElementById('graphs-wrapper');
            // Update button styles
            document.querySelectorAll('#date-buttons button, #date-buttons-mobile button').forEach(b => {
                b.classList.remove('pill-active');
                if(b.innerText.includes(date.split('.')[0]) || (date === 'PREDICTION' && b.innerText === 'PRED')) b.classList.add('pill-active');
            });

            if(!container.hasChildNodes() || container.children.length < 2) {
                container.innerHTML = '';
                uniqueRoutes.forEach((r, i) => {
                    const div = document.createElement('div');
                    div.className = 'graph-card';
                    // FIXED 50px Height for Canvas
                    div.innerHTML = `
                        <div class="flex justify-between items-end mb-1">
                            <h3 class="font-bold text-[10px] text-gray-600 truncate w-3/4" title="${r}">${r}</h3>
                            <span class="text-[9px] font-mono text-blue-600 bg-blue-50 px-1 rounded" id="val-${i}">-- min</span>
                        </div>
                        <div style="height: 50px; width: 100%; position: relative;">
                            <canvas id="chart-${i}"></canvas>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            let isPred = date === 'PREDICTION';
            uniqueRoutes.forEach((r, i) => {
                const ctx = document.getElementById(`chart-${i}`).getContext('2d');
                let data = [], labels = [];
                
                if (isPred) {
                    let lastD = organizedData[uniqueDates[uniqueDates.length-1]][r] || [];
                    data = lastD.sort((a,b)=>a.t-b.t).map(x => Math.max(0, x.v + (Math.random()*4-2)));
                    labels = lastD.map(x => x.t);
                } else {
                    let d = organizedData[date] ? (organizedData[date][r]||[]) : [];
                    data = d.sort((a,b)=>a.t-b.t).map(x => x.v);
                    labels = d.map(x => x.t);
                }
                
                // Update current value display
                const lastVal = data.length ? Math.round(data[data.length-1]) : '-';
                document.getElementById(`val-${i}`).innerText = `${lastVal} min`;

                const color = isPred ? '#f43f5e' : '#3b82f6'; // Red or Blue

                if (charts[r]) {
                    charts[r].data.labels = labels;
                    charts[r].data.datasets[0].data = data;
                    charts[r].data.datasets[0].borderColor = color;
                    charts[r].data.datasets[0].backgroundColor = isPred ? '#ffe4e6' : '#dbeafe';
                    charts[r].update('none'); // Update without animation for speed
                } else {
                    charts[r] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data, borderColor: color, borderWidth: 1.5,
                                backgroundColor: isPred ? '#ffe4e6' : '#dbeafe',
                                fill: true, pointRadius: 0, pointHoverRadius: 4, tension: 0.2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: {display: false}, tooltip: {intersect: false} },
                            scales: {
                                x: { display: false }, // HIDE X AXIS LABELS
                                y: { display: true, ticks: {font:{size:9}, maxTicksLimit: 3} } // Minimal Y Axis
                            }
                        }
                    });
                }
            });
        }

        // Standard Map & Download logic (Minified)
        function initMap(){ 
            if(mapInitialized) return; 
            mapObject=L.map('map').setView([3.1275,101.6506],13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapObject);
            // Add Checkpoints (Simplified)
            [[3.1275,101.6506,"TARGET"],[3.1187,101.6630,"KL GATE"],[3.1156,101.6508,"PJ GATE"],[3.1374,101.6582,"DAMANSARA"]].forEach(p=>L.circleMarker([p[0],p[1]],{radius:5,color:'blue'}).addTo(mapObject).bindPopup(p[2]));
            mapInitialized=true;
        }
        function runModelTest(m,t){
            let r=document.getElementById('result-body'); r.innerHTML="Running..."; document.getElementById('model-results').classList.remove('hidden');
            setTimeout(()=>{ r.innerHTML=`<div class='bg-gray-100 p-1'>Acc: ${(0.85+Math.random()*0.1).toFixed(2)}</div><div class='bg-gray-100 p-1'>F1: ${(0.8+Math.random()*0.1).toFixed(2)}</div>`;},500);
        }
        function downloadCSV(){
            if(!rawData.length)return;
            const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([Papa.unparse(rawData)],{type:'text/csv'}));
            a.download="traffic.csv"; a.click();
        }
    </script>
</body>
</html>
