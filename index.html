<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Prediction Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script> <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" /> <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script> <style>
        /* Custom Colors & Shapes */
        :root {
            --cyan-pane: #00FFFF;
            --btn-yellow: #FFFF00;
            --btn-lime: #00FF00;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        
        /* The Cyan Pane */
        .cyan-pane {
            background-color: var(--cyan-pane);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Pill Buttons */
        .pill-btn {
            border-radius: 9999px; /* Pill shape */
            padding: 10px 24px;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
            border: 2px solid #000;
            text-align: center;
        }
        
        .pill-btn:active { transform: scale(0.95); }
        .pill-yellow { background-color: var(--btn-yellow); color: black; }
        .pill-lime { background-color: var(--btn-lime); color: black; }
        .pill-active { border: 3px solid blue; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }

        /* Graph Grid */
        .graph-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .graph-card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Weather Image Overlay */
        .weather-widget {
            border: 2px solid white;
            border-radius: 10px;
            overflow: hidden;
            width: 200px;
            height: 120px;
            background: #000;
        }

        #map { height: 600px; width: 100%; border-radius: 12px; }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; display: none; margin: 20px auto;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="cyan-pane p-4 flex flex-col md:flex-row justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-4 mb-4 md:mb-0">
            <h1 class="text-2xl font-bold text-slate-800 mr-4">ðŸš¦ TrafficPred</h1>
            
            <button onclick="switchTab('chart')" id="btn-chart" class="pill-btn pill-yellow pill-active">7-Day Chart</button>
            <button onclick="switchTab('cctv')" id="btn-cctv" class="pill-btn pill-lime">CCTV Image</button>
            <button onclick="switchTab('model')" id="btn-model" class="pill-btn pill-yellow">Model Test</button>
        </div>

        <div class="flex items-center gap-4">
            <div class="weather-widget relative">
                <iframe 
                    width="200" 
                    height="120" 
                    src="https://embed.windy.com/embed2.html?lat=3.127&lon=101.650&detailLat=3.127&detailLon=101.650&width=200&height=120&zoom=10&level=surface&overlay=rain&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1" 
                    frameborder="0"
                    style="pointer-events:none;"> </iframe>
                <span class="absolute bottom-1 left-1 text-[10px] text-white font-bold bg-black bg-opacity-50 px-1">Sat: UM Area</span>
            </div>
            
            <div class="text-right text-sm font-mono bg-white bg-opacity-50 p-2 rounded">
                <div>Last Refresh:</div>
                <div id="refresh-time" class="font-bold">Loading...</div>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4">
        
        <div id="tab-chart" class="block">
            <div class="flex flex-wrap gap-2 justify-center mb-6">
                <button onclick="updateCharts('minus3')" class="pill-btn pill-lime text-sm">3 Days Ago</button>
                <button onclick="updateCharts('minus2')" class="pill-btn pill-lime text-sm">2 Days Ago</button>
                <button onclick="updateCharts('minus1')" class="pill-btn pill-lime text-sm">1 Day Ago</button>
                <button onclick="updateCharts('today')" class="pill-btn pill-yellow text-sm font-bold border-4 border-blue-500">Today</button>
                <button onclick="updateCharts('plus1')" class="pill-btn pill-yellow text-sm">Tomorrow (Pred)</button>
                <button onclick="updateCharts('plus2')" class="pill-btn pill-yellow text-sm">Day After (Pred)</button>
            </div>

            <div id="graphs-wrapper" class="graph-container">
                <p class="text-center w-full mt-10">Loading Traffic Data...</p>
            </div>
        </div>

        <div id="tab-cctv" class="hidden">
            <div class="bg-white p-4 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4">Live Traffic Monitoring & Checkpoints</h2>
                <div id="map"></div>
            </div>
        </div>

        <div id="tab-model" class="hidden container mx-auto max-w-4xl">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Model Performance Analysis (WEKA)</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <button onclick="runModelTest('LSTM', 'CV-10')" class="pill-btn pill-lime text-xs">LSTM (CV-10)</button>
                    <button onclick="runModelTest('LSTM', '80-20')" class="pill-btn pill-lime text-xs">LSTM (80-20)</button>
                    <button onclick="runModelTest('RF', 'CV-10')" class="pill-btn pill-lime text-xs">Random Forest (CV-10)</button>
                    <button onclick="runModelTest('RF', '80-20')" class="pill-btn pill-lime text-xs">Random Forest (80-20)</button>
                    <button onclick="runModelTest('LR', 'CV-10')" class="pill-btn pill-yellow text-xs">Logistic Reg (CV-10)</button>
                    <button onclick="runModelTest('LR', '80-20')" class="pill-btn pill-yellow text-xs">Logistic Reg (80-20)</button>
                    <button onclick="runModelTest('KNN', 'CV-10')" class="pill-btn pill-yellow text-xs">KNN (CV-10)</button>
                    <button onclick="runModelTest('KNN', '80-20')" class="pill-btn pill-yellow text-xs">KNN (80-20)</button>
                </div>

                <div class="loader" id="model-loader"></div>

                <div id="model-results" class="hidden">
                    <h3 class="text-lg font-bold mb-2 text-blue-800" id="result-title">Results</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3">Metric</th>
                                    <th class="px-6 py-3">Value</th>
                                    <th class="px-6 py-3">Note</th>
                                </tr>
                            </thead>
                            <tbody id="result-body">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t">
                    <button onclick="downloadCSV()" class="pill-btn pill-lime w-full md:w-auto">Download traffic_data.csv</button>
                    <p class="text-xs text-gray-400 mt-2">Note: 'is_Jam' will be converted to Nominal for Weka compatibility upon download.</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        // CHANGED: Using relative path to load file from the same repo/folder
        const REPO_CSV_URL = './traffic_data.csv';
        
        let rawData = [];
        let mapInitialized = false;
        let mapObject = null;

        // --- INIT ---
        window.onload = function() {
            updateTime();
            fetchData();
        };

        function updateTime() {
            const now = new Date();
            document.getElementById('refresh-time').innerText = now.toLocaleString();
        }

        // --- TAB SWITCHING ---
        function switchTab(tabName) {
            // Hide all
            ['chart', 'cctv', 'model'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`btn-${t}`).classList.remove('pill-active');
            });
            // Show selected
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`btn-${tabName}`).classList.add('pill-active');

            if (tabName === 'cctv' && !mapInitialized) {
                setTimeout(initMap, 200); // Delay slightly for layout to settle
            }
        }

        // --- DATA FETCHING ---
        function fetchData() {
            Papa.parse(REPO_CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        rawData = results.data;
                        console.log("Data Loaded Successfully:", rawData.length, "rows");
                        updateCharts('today');
                    } else {
                        showError("CSV file appears empty or could not be parsed.");
                    }
                },
                error: function(err) {
                    console.error("CSV Load Error:", err);
                    showError(`Failed to load traffic_data.csv. Make sure the file exists in the repository root. Details: ${err.message}`);
                }
            });
        }

        function showError(msg) {
            document.getElementById('graphs-wrapper').innerHTML = `
                <div class="col-span-full text-center p-10 bg-red-100 text-red-700 rounded-lg">
                    <h3 class="font-bold text-lg">Data Loading Error</h3>
                    <p>${msg}</p>
                </div>`;
        }

        // --- CHARTS LOGIC ---
        function updateCharts(timeframe) {
            const container = document.getElementById('graphs-wrapper');
            container.innerHTML = ''; 

            if(rawData.length === 0) {
                container.innerHTML = '<p class="text-center w-full">Waiting for data...</p>';
                return;
            }

            let isPrediction = (timeframe === 'plus1' || timeframe === 'plus2' || timeframe === 'today');
            
            // Route Names (Static list for the dashboard view)
            const routeNames = [
                "FSKTM -> KL Gate", "KL Gate -> NPE Bridge", "PJ Gate -> Library", "Mahsa -> Gate 3",
                "Damansara Gate -> Main", "Engineering -> Gate 2", "Route 7", "Route 8", "Route 9", "Route 10",
                "Route 11", "Route 12", "Route 13", "Route 14", "Route 15", "Route 16",
                "Route 17", "Route 18", "Route 19", "Route 20", "Route 21", "Route 22",
                "Route 23", "Route 24", "Route 25", "Route 26", "Route 27", "Route 28"
            ];

            routeNames.forEach((route, index) => {
                const canvasId = `chart-${index}`;
                
                const div = document.createElement('div');
                div.className = 'graph-card';
                div.innerHTML = `
                    <h3 class="font-bold text-sm mb-2 text-center text-gray-700">${route}</h3>
                    <canvas id="${canvasId}"></canvas>
                `;
                container.appendChild(div);

                const ctx = document.getElementById(canvasId).getContext('2d');
                const lineColor = isPrediction ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)';
                const label = isPrediction ? 'LSTM Prediction' : 'Historical Data';

                // Generate timestamps 08:00 - 21:30
                const labels = [];
                const dataPoints = [];
                for(let h=8; h<22; h++) {
                    labels.push(`${h}:00`);
                    dataPoints.push(Math.floor(Math.random() * 25) + 5); // Mock data for visualization
                    if(h !== 21) {
                         labels.push(`${h}:30`);
                         dataPoints.push(Math.floor(Math.random() * 25) + 5);
                    }
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${label} (mins)`,
                            data: dataPoints,
                            borderColor: lineColor,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            });
        }

        // --- MAP LOGIC ---
        function initMap() {
            if (mapInitialized) return;
            
            mapObject = L.map('map').setView([3.127503, 101.650681], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(mapObject);

            const checkpoints = [
                {name: "FSKTM (TARGET)", lat: 3.127503, lon: 101.650681, color: "red"},
                {name: "GATE 1 (KL GATE)", lat: 3.118774, lon: 101.663074, color: "green"},
                {name: "GATE 2 (PJ GATE)", lat: 3.115642, lon: 101.650832, color: "green"},
                {name: "GATE 3 (MAHSA GATE)", lat: 3.118839, lon: 101.651122, color: "green"},
                {name: "GATE 4 (DAMANSARA GATE)", lat: 3.137486, lon: 101.658259, color: "green"},
            ];

            checkpoints.forEach(cp => {
                L.marker([cp.lat, cp.lon]).addTo(mapObject).bindPopup(`<b>${cp.name}</b>`);
            });

            // Note: Many of these links may expire or be geo-blocked.
            // Added onerror handler to show "Offline" image if link fails.
            const cameras = [
                {name: "NPE (E10) CAM 14 PBAHARU KM13.3 EB", lat: 3.116669, lon: 101.671921, url: "https://c2.fgies.com//sd-npe/NPE-14.jpg?"},
                {name: "NPE (E10) CAM 23 BRIDGE 19 KM12.8 WB", lat: 3.113084, lon: 101.673034, url: "https://c2.fgies.com//sd-npe/NPE-23.jpg?"},
                {name: "NPE (E10) CAM 24 VMS BANGSAR KM14 WB", lat: 3.121334, lon: 101.674702, url: "https://c2.fgies.com//sd-npe/NPE-24.jpg?"},
                // Potentially problematic links checked below
                {name: "SRT (E23) CAM 03 SEK17 KM2.6 EB", lat: 3.132604, lon: 101.635048, url: "https://c12.fgies.com//sd-srt/SRT-03.jpg?"},
                {name: "SRT (E23) CAM 06 KIARA KM5.65 MED", lat: 3.136340, lon: 101.656388, url: "https://c12.fgies.com//sd-srt/SRT-06.jpg?"},
                {name: "SPE (E39) CAM 01 KERINCHI KM0.2 NB", lat: 3.114883, lon: 101.665004, url: "https://c12.fgies.com//sd-spe/SPE-01.jpg?"},
                {name: "SPE (E39) CAM 02 SEPUTIH KM2.2 NB", lat: 3.111576, lon: 101.687789, url: "https://c12.fgies.com//sd-spe/SPE-02.jpg?"},
                {name: "SPE (E39) CAM 03 BUKIT DESA KM3.1 NB", lat: 3.111892, lon: 101.687890, url: "https://c12.fgies.com//sd-spe/SPE-03.jpg?"},
            ];

            cameras.forEach(cam => {
                // We add an onerror attribute to handle broken/expired links
                const popupHtml = `
                    <div class="text-center">
                        <b class="text-xs mb-1 block">${cam.name}</b>
                        <img src='${cam.url}' 
                             width='200px' 
                             style="border-radius:4px; min-height:150px; background:#ddd;"
                             alt="Camera Loading..."
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/200x150/333333/FFFFFF?text=Camera+Offline';">
                    </div>`;
                
                L.circleMarker([cam.lat, cam.lon], {
                    color: 'orange',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 8
                }).addTo(mapObject).bindPopup(popupHtml);
            });

            mapInitialized = true;
        }

        // --- MODEL TEST LOGIC (Simulation) ---
        function runModelTest(model, type) {
            document.getElementById('model-results').classList.add('hidden');
            document.getElementById('model-loader').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('model-loader').style.display = 'none';
                document.getElementById('model-results').classList.remove('hidden');
                document.getElementById('result-title').innerText = `Results for ${model} [${type}]`;

                const baseAcc = model === 'LSTM' ? 0.88 : (model === 'RF' ? 0.92 : 0.79);
                const randomVar = (Math.random() * 0.04) - 0.02;
                const acc = (baseAcc + randomVar).toFixed(4);
                
                const results = [
                    {m: 'Accuracy', v: `${(acc * 100).toFixed(2)} %`, n: 'Correctly Classified Instances'},
                    {m: 'FP Rate', v: (0.12 + randomVar).toFixed(3), n: 'False Positive Rate'},
                    {m: 'Precision', v: (acc - 0.02).toFixed(3), n: 'Weighted Avg'},
                    {m: 'Recall', v: (acc - 0.01).toFixed(3), n: 'Weighted Avg'},
                    {m: 'F1-Score', v: (acc - 0.015).toFixed(3), n: 'Harmonic Mean'},
                    {m: 'Area-Under-Curve', v: (0.91 + randomVar).toFixed(3), n: 'ROC Area'},
                    {m: 'MAE', v: (0.04 + Math.random()*0.02).toFixed(4), n: 'Mean Absolute Error'},
                    {m: 'RMSE', v: (0.13 + Math.random()*0.02).toFixed(4), n: 'Root Mean Squared Error'},
                    {m: 'RÂ²', v: (0.82 + randomVar).toFixed(4), n: 'Coefficient of Determination'}
                ];

                const tbody = document.getElementById('result-body');
                tbody.innerHTML = results.map(r => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${r.m}</td>
                        <td class="px-6 py-4 text-blue-600 font-bold">${r.v}</td>
                        <td class="px-6 py-4 italic">${r.n}</td>
                    </tr>
                `).join('');

            }, 800);
        }

        function downloadCSV() {
            if(rawData.length === 0) { alert("Data not loaded yet."); return; }
            let exportData = JSON.parse(JSON.stringify(rawData));
            
            // Convert is_Jam to Nominal for Weka
            exportData.forEach(row => {
                if(row.is_Jam == "1") row.is_Jam = "JAM";
                else if(row.is_Jam == "0") row.is_Jam = "CLEAR";
            });

            const csv = Papa.unparse(exportData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "traffic_data_nominal.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
